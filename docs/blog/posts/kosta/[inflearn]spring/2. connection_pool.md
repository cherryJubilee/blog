---
draft: false
authors:
    - hyewon
date: 2024-08-09
categories:
    - spring
    - db
---

<!-- more -->

## DB Connection ê³¼ì •

jdbc ë“œë¼ì´ë²„ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ ë§¤ë²ˆ íšë“í–ˆë‹¤.
ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤. ì»¤ë„¥ì…˜ì„ ìƒˆë¡œ ìƒì„±í•˜ê¸° ìœ„í•´ ë¦¬ì†ŒìŠ¤ë¥¼ ë§¤ë²ˆ ì‚¬ìš©í•´ì•¼í•˜ê³ , ê³ ê°ë“¤ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•  ë–„ SQLë¬¸ì„ ì‹¤í–‰í•˜ëŠ” ì‹œê°„ ë¿ë§Œ ì•„ë‹ˆë¼ ì»¤ë„¥ì…˜ì„ ìƒˆë¡œ ë§Œë“œëŠ” ì‹œê°„ë„ ì¶”ê°€ë˜ì–´ ì‘ë‹µì†ë„ì— ì˜í–¥ì„ ë¯¸ì¹˜ê²Œ ëœë‹¤. ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì»¤ë„¥ì…˜ì„ ë¯¸ë¦¬ ìƒì„±í•´ë‘ê³  ì‚¬ìš©í•˜ëŠ” ì»¤ë„¥ì…˜í’€ ì´ë¼ëŠ” ë°©ë²•ì´ ë‚˜ì™”ë‹¤.

1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì€ DB ë“œë¼ì´ë²„ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ ì¡°íšŒí•œë‹¤.
2. DB ë“œë¼ì´ë²„ëŠ” DBì™€ `TCP/IP` ì»¤ë„¥ì…˜ì„ ì—°ê²°í•œë‹¤. ë¬¼ë¡  ì´ ê³¼ì •ì—ì„œ 3 way handshake ê°™ì€ `TCP/IP` ì—°ê²°ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ë™ì‘ì´ ë°œìƒí•œë‹¤.
3. DB ë“œë¼ì´ë²„ëŠ” `TCP/IP` ì»¤ë„¥ì…˜ì´ ì—°ê²°ë˜ë©´ ID, PWì™€ ê¸°íƒ€ ë¶€ê°€ì •ë³´ë¥¼ DBì— ì „ë‹¬í•œë‹¤.
4. DBëŠ” ID, PWë¥¼ í†µí•´ ë‚´ë¶€ ì¸ì¦ì„ ì™„ë£Œí•˜ê³ , ë‚´ë¶€ì— DB ì„¸ì…˜ì„ ìƒì„±í•œë‹¤.
5. DBëŠ” ì»¤ë„¥ì…˜ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆë‹¤ëŠ” ì‘ë‹µì„ ë³´ë‚¸ë‹¤.
6. DB ë“œë¼ì´ë²„ëŠ” ì»¤ë„¥ì…˜ ê°ì²´ë¥¼ ìƒì„±í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜í•œë‹¤.

## Connection Pool

ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì—ì„œ DBë“œë¼ì´ë²„ë¥¼ í†µí•´ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì»¤ë„¥ì…˜ í’€ì„ í†µí•´ ì´ë¯¸ ìƒì„±ëœ ì»¤ë„¥ì…˜ì„ ê°ì²´ ì°¸ì¡°ë¡œ ê°€ì ¸ë‹¤ ì“°ëŠ” ê²ƒì´ë‹¤.

> Drive Connection ê³¼ì • 2ê°€ì§€

![alt text](image-6.png)

1. ì‹ ê·œ ì»¤ë„¥ì…˜ ìƒì„±
2. ì»¤ë„¥ì…˜ í’€ì— ë¯¸ë¦¬ ìƒì„±ëœ ê²ƒ ì¡°íšŒ

## DataSource

> ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ë°©ë²•ì„ ì¶”ìƒí™”í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤

![alt text](image-7.png)

```java
public interface DataSource {
   Connection getConnection() throws SQLException;
}
```

ìë°”ëŠ” `Datasource`ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ë°©ë²•ì„ ì¶”ìƒí™”í–ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì€ `Datasource` ì¸í„°í˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´í•˜ë©´ ëœë‹¤. ë”°ë¼ì„œ `DriverManager DataSource`ë¥¼ í†µí•´ì„œ `DriverManage`ë¥¼ ì‚¬ìš©í•˜ë‹¤ê°€ ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ë„ë¡ ì½”ë“œë¥¼ ë³€ê²½í•´ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì€ ë³€ê²½í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

### ğŸ€ Datasource ì˜ˆì œ1 - DriverManager

> Datasource ì‹¤í–‰ê²°ê³¼

```shell
17:46:51.154 [main] INFO hello.jdbc.connection.ConnectionTest -- connection = conn0: url=jdbc:h2:tcp://localhost/~/test user=SA, class = class org.h2.jdbc.JdbcConnection
17:46:51.156 [main] INFO hello.jdbc.connection.ConnectionTest -- connection = conn1: url=jdbc:h2:tcp://localhost/~/test user=SA, class = class org.h2.jdbc.JdbcConnection
17:46:51.173 [main] INFO hello.jdbc.connection.ConnectionTest -- connection = conn2: url=jdbc:h2:tcp://localhost/~/test user=SA, class = class org.h2.jdbc.JdbcConnection
17:46:51.173 [main] INFO hello.jdbc.connection.ConnectionTest -- connection = conn3: url=jdbc:h2:tcp://localhost/~/test user=SA, class = class org.h2.jdbc.JdbcConnection


```

### ì°¨ì´ì 

-   ê¸°ì¡´ `DriverManager` ë¥¼ í†µí•´ì„œ ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ë°©ë²•ê³¼ `DataSource` ë¥¼ í†µí•´ì„œ ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ë°©ë²•ì—ëŠ” ì°¨ì´ê°€ ìˆë‹¤.
-   ì„¤ì •ê³¼ ì‚¬ìš©ì„ ë¶„ë¦¬í–ˆë‹¤.

-   `DriverManager` ëŠ” ì»¤ë„¥ì…˜ì„ íšë“í•  ë•Œ ë§ˆë‹¤ `URL` , `USERNAME` , `PASSWORD` ê°™ì€ íŒŒë¼ë¯¸í„°ë¥¼ ê³„ì† ì „ë‹¬í•´ì•¼ í•œë‹¤. ë°˜ë©´ì— `DataSource` ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì€ ì²˜ìŒ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œë§Œ í•„ìš”í•œ íŒŒë¦¬ë¯¸í„°ë¥¼ ë„˜ê²¨ë‘ê³ , ì»¤ë„¥ì…˜ì„ íšë“í•  ë•ŒëŠ” ë‹¨ìˆœíˆ `dataSource.getConnection()` ë§Œ í˜¸ì¶œí•˜ë©´ ëœë‹¤.

> DriverManager

```java
DriverManager.getConnection(URL, USERNAME, PASSWORD)
DriverManager.getConnection(URL, USERNAME, PASSWORD)
```

> DataSource

```java
 void dataSourceDriverManager() throws SQLException {
     DriverManagerDataSource dataSource = new DriverManagerDataSource(URL,
 USERNAME, PASSWORD);
     useDataSource(dataSource);
}

private void useDataSource(DataSource dataSource) throws SQLException {
     Connection con1 = dataSource.getConnection();
     Connection con2 = dataSource.getConnection();
     log.info("connection={}, class={}", con1, con1.getClass());
     log.info("connection={}, class={}", con2, con2.getClass());
}
```

<details>
<summary>Datasource ì˜ˆì œ1 - DriverManager</summary>

```java
package hello.jdbc.connection;

import lombok.extern.slf4j.Slf4j;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

import static hello.jdbc.connection.ConnectionConst.*;

@Slf4j
public class DBConnectionUtil {

    public static Connection getConnection() {

        try {
            // ì´ ì»¤ë„¥ì…˜ì„ DBê°€ ë°”ë€ë‹¤ê³  í•´ì„œ ë°”ê¿€ í•„ìš”ê°€ ì—†ë‹¤. Connectionì´ JDBC í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ì´ê¸°
            Connection connection = DriverManager.getConnection(URL, USERNAME, PASSWORD);
            log.info("get Connection = {}, class = {}",connection , connection.getClass());
            return  connection;
        } catch (SQLException e) {
            throw new IllegalStateException(e);
        }

    }

}

```

```java
package hello.jdbc.connection;

import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.jdbc.datasource DriverManagerDataSource;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

import static hello.jdbc.connection.ConnectionConst.*;

@Slf4j
public class ConnectionTest {
    @Test
    void driveManager() throws SQLException {
        Connection con1 = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        Connection con2 = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        log.info("connection = {}, class = {}", con1, con1.getClass());
        log.info("connection = {}, class = {}", con2, con2.getClass());
    }

    @Test
    void dataSourceDriverManager() throws SQLException {
        //DriverManagerDataSource - í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ íšë“
        DriverManagerDataSource datasource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        useDataSource(datasource);
    }

    private void useDataSource(DataSource dataSource) throws SQLException {

        Connection con1 = dataSource.getConnection();
        Connection con2 = dataSource.getConnection();
        log.info("connection = {}, class = {}", con1, con1.getClass());
        log.info("connection = {}, class = {}", con2, con2.getClass());
    }
}


```

</details>

### ğŸ€ Datasource ì˜ˆì œ2 - connection Pool

<details>
<summary>Datasource ì˜ˆì œ2 - connection Pool</summary>

```java
package hello.jdbc.connection;

import com.zaxxer.hikari.HikariDataSource;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

import static hello.jdbc.connection.ConnectionConst.*;

@Slf4j
public class ConnectionTest {
    @Test
    void driveManager() throws SQLException {
        Connection con1 = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        Connection con2 = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        log.info("connection = {}, class = {}", con1, con1.getClass());
        log.info("connection = {}, class = {}", con2, con2.getClass());
    }

    @Test
    void dataSourceDriverManager() throws SQLException {
        //DriverManagerDataSource - í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ íšë“
        DriverManagerDataSource datasource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        useDataSource(datasource);
    }

    @Test
    void dataSourceConnectionPool() throws SQLException, InterruptedException {
        // ì»¤ë„¥ì…˜ í’€ë§
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(URL);
        dataSource.setUsername(USERNAME);
        dataSource.setPassword(PASSWORD);
        dataSource.setPoolName("MyPool");
        dataSource.setMaximumPoolSize(10);

        useDataSource(dataSource);
        Thread.sleep(1000);

    }
    private void useDataSource(DataSource dataSource) throws SQLException {

        Connection con1 = dataSource.getConnection();
        Connection con2 = dataSource.getConnection();
        log.info("connection = {}, class = {}", con1, con1.getClass());
        log.info("connection = {}, class = {}", con2, con2.getClass());
    }
}
```

ğŸ¤” ì™œ ë³„ë„ì˜ ì“°ë ˆë“œë¥¼ ì‚¬ìš©í•´ì„œ ì»¤ë„¥ì…˜ í’€ì— ì»¤ë„¥ì…˜ì„ ì±„ìš°ëŠ” ê²ƒì¼ê¹Œ?  
ì»¤ë„¥ì…˜ í’€ì— ì»¤ë„¥ì…˜ì„ ì±„ìš°ëŠ” ê²ƒì€ ìƒëŒ€ì ìœ¼ë¡œ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì¼ì´ë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•  ë•Œ ì»¤ë„¥ì…˜ í’€ì„ ì±„ìš¸ ë•Œ ê¹Œ ì§€ ë§ˆëƒ¥ ëŒ€ê¸°í•˜ê³  ìˆë‹¤ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œê°„ì´ ëŠ¦ì–´ì§„ë‹¤. ë”°ë¼ì„œ ì´ë ‡ê²Œ ë³„ë„ì˜ ì“°ë ˆë“œë¥¼ ì‚¬ìš©í•´ì„œ ì»¤ë„¥ì…˜ í’€ì„ ì±„ ì›Œì•¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œê°„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.

ğŸ¤” ì •í•´ë‘” ì»¤ë„¥ì…˜í’€ ìµœëŒ€ ê°œìˆ˜ë¥¼ ëª¨ë‘ ì±„ìš´ë‹¤ë©´?  
-> ëª‡ì´ˆê°„ ëŒ€ê¸°í•˜ë‹¤ê°€ ì—ëŸ¬ë°œìƒ

ğŸ¤” ì»¤ë„¥ì…˜ í’€ì—ì„œ ì»¤ë„¥ì…˜ íšë“  
ì»¤ë„¥ì…˜ í’€ì—ì„œ ì»¤ë„¥ì…˜ì„ íšë“í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ì¶œë ¥í–ˆë‹¤. ì—¬ê¸°ì„œëŠ” ì»¤ë„¥ì…˜ í’€ì—ì„œ ì»¤ë„¥ì…˜ì„ 2ê°œ íšë“í•˜ê³  ë°˜í™˜í•˜ì§€ëŠ” ì•Šì•˜ë‹¤. ë”°ë¼ì„œ í’€ì— ìˆëŠ” 10ê°œì˜ ì»¤ë„¥ì…˜ ì¤‘ì— 2ê°œë¥¼ ê°€ì§€ê³  ìˆëŠ” ìƒíƒœì´ë‹¤. ê·¸ë˜ì„œ ë§ˆì§€ë§‰ ë¡œê·¸ë¥¼ ë³´ë©´ ì‚¬ìš©ì¤‘ì¸ ì»¤ë„¥ì…˜
`active=2` , í’€ì—ì„œ ëŒ€ê¸° ìƒíƒœì¸ ì»¤ë„¥ì…˜ `idle=8` ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

-   `MyPool - After adding stats (total=10, active=2, idle=8, waiting=0)`

</details>

### ğŸ€ Datasource ì˜ˆì œ3

> driverManager

```java
@BeforeEach
    void beforeEach() {
        // ê¸°ë³¸ driverManager - í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ íšë“
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        repository = new MemberRepositoryV1(dataSource);
    }
```

ğŸ˜ í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì´ ìƒì„±ë˜ëŠ” ê²ƒ í™•ì¸

![alt text](image-9.png)

> ì»¤ë„¥ì…˜ í’€ë§

```java
 @BeforeEach
    void beforeEach() {
        // ì»¤ë„¥ì…˜ í’€ë§: HikariProxyConnection -> JdbcConnection
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(URL);
        dataSource.setUsername(USERNAME);
        dataSource.setPassword(PASSWORD);

        repository = new MemberRepositoryV1(dataSource);
    }
```

ğŸ˜ conn0 ë§Œ ì‚¬ìš©ë˜ëŠ” ê²ƒ ì²˜ëŸ¼ ë³´ì´ëŠ” ì´ìœ ?
![alt text](image-8.png)

-   ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ì‹œ `conn0` ì»¤ë„¥ì…˜ì´ ì¬ì‚¬ìš© ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
-   í…ŒìŠ¤íŠ¸ëŠ” ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ê³  ë‹¤ì‹œ ëŒë ¤ì£¼ëŠ” ê²ƒì„ ë°˜ë³µí•œë‹¤. ë”°ë¼ì„œ `conn0` ë§Œ ì‚¬ìš©ëœë‹¤.
-   ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì—¬ëŸ¬ ì“°ë ˆë“œì—ì„œ ì»¤ë„¥ì…˜ í’€ì˜ ì»¤ë„¥ì…˜ì„ ë‹¤ì–‘í•˜ê²Œ ê°€ì ¸ê°€ëŠ” ìƒí™© ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
